{"ast":null,"code":"var _ = require('lodash');\n\nvar extractHostPartsRE1x = /\\[(?:(.*)\\/)?(.+?):(\\d+)\\]/;\n\nfunction makeNodeParser(hostProp) {\n  return function (nodes) {\n    return _.transform(nodes, function (hosts, node, id) {\n      var address = _.get(node, hostProp);\n\n      if (!address) return;\n      var host = {\n        host: undefined,\n        port: undefined,\n        _meta: {\n          id: id,\n          name: node.name,\n          version: node.version\n        }\n      };\n      var malformedError = new Error('Malformed ' + hostProp + '.' + ' Got ' + JSON.stringify(address) + ' and expected it to match \"{hostname?}/{ip}:{port}\".');\n      var matches1x = extractHostPartsRE1x.exec(address);\n\n      if (matches1x) {\n        host.host = matches1x[1] || matches1x[2];\n        host.port = parseInt(matches1x[3], 10);\n        hosts.push(host);\n        return;\n      }\n\n      if (address.indexOf('/') > -1) {\n        var withHostParts = address.split('/');\n        if (withHostParts.length !== 2) throw malformedError;\n        host.host = withHostParts.shift();\n        address = withHostParts.shift();\n      }\n\n      if (address.indexOf(':') < 0) {\n        throw malformedError;\n      }\n\n      var addressParts = address.split(':');\n\n      if (addressParts.length !== 2) {\n        throw malformedError;\n      }\n\n      host.host = host.host || addressParts[0];\n      host.port = parseInt(addressParts[1], 10);\n      hosts.push(host);\n    }, []);\n  };\n}\n\nmodule.exports = makeNodeParser('http.publish_address');","map":null,"metadata":{},"sourceType":"script"}